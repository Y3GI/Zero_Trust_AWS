name: Zero Trust AWS Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      actions:
        description: "apply or destroy"
        required: true
        default: "apply"
        type: choice
        options: [apply, destroy]
permissions:
  id-token: write
  contents: read
  security-events: write
jobs:
  cache:
    name: Cache Terraform Plugins
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # Updated from v3

      - name: Terraform cache
        uses: actions/cache@v4  # Updated from v3
        with:
          path: ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/terraform.lock.hcl') }}

  validate:
    name: Validate Infrastructure as Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # Updated from v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-north-1

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.5

      - name: Terraform validate
        working-directory: ./scripts/
        run: ./build.sh

  terraform_operations:
    needs: [cache, validate]
    name: Terraform Operations
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4  # Updated from v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-north-1

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.7.5

      - name: Terraform deploy
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.actions == 'apply') }}
        working-directory: ./scripts/
        run: ./deploy.sh --auto-approve

      - name: Terraform destroy
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.actions == 'destroy' }}
        working-directory: ./scripts/
        run: ./destroy.sh --auto-approve

  quality_check:
    needs: [terraform_operations]
    name: Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.actions == 'apply')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # Updated from v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-north-1

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v4  # Updated from v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install Go dependencies
        run: go mod download

      - name: Tidy Go modules
        run: go mod tidy

      - name: Run Terratest Integration Tests
        run: go test -v ./test/... -timeout 60m
        env:
          AWS_DEFAULT_REGION: eu-north-1

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: terraform

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

# If you add artifact uploads later, use v4:
# uses: actions/upload-artifact@v4
# uses: actions/download-artifact@v4
